<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Image CDN</title>

    <!-- Base OG tags -->
    <meta property="og:title" content="Image CDN" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="" x-data x-init="$el.content = window.location.href" />
    <meta property="og:description" content="Upload and manage your images" />
    <meta property="og:site_name" content="Image CDN" />

    <!-- Dynamic OG tags for images -->
    <template x-if="images && images.length > 0">
        <div>
            <meta property="og:image" x-bind:content="images[0].url" />
            <meta property="og:image:width" content="1200" />
            <meta property="og:image:height" content="630" />
            <meta property="og:image:alt" x-bind:content="images[0].filename" />
        </div>
    </template>

    <!-- Twitter Card tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Image CDN" />
    <meta name="twitter:description" content="Upload and manage your images" />
    <template x-if="images && images.length > 0">
        <meta name="twitter:image" x-bind:content="images[0].url" />
    </template>

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Toastify JS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl" x-data="{ 
        images: [], 
        loading: true,
        init() {
            this.$watch('images', (value) => {
                console.log('Images array updated:', value);
            });
            
            fetch('/image')
                .then(response => response.json())
                .then(data => {
                    console.log('Initial image list data:', data);
                    this.images = data.hashes.map(item => ({
                        hash: item.hash,
                        size: item.size,
                        uploadedAt: item.uploadedAt
                    }));
                    this.loading = false;
                })
                .catch(error => {
                    console.error('Error loading images:', error);
                    this.loading = false;
                });
        }
    }">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-primary mb-4">Image CDN</h1>
            <p class="text-base-content/70">Upload and manage your images</p>
        </header>

        <section class="bg-base-100 p-8 rounded-box shadow-sm mb-8">
            <form hx-encoding="multipart/form-data" hx-post="/upload"
                hx-trigger="change from:#fileInput, change from:#cameraInput" hx-target="#previewContainer"
                hx-swap="innerHTML" hx-indicator="#uploadProgress" class="flex flex-col gap-4">
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <label
                        class="flex-1 flex flex-col items-center justify-center p-4 bg-base-200 border-2 border-base-300 rounded-lg cursor-pointer hover:border-primary transition-colors"
                        id="fileOption">
                        <input type="file" accept="image/*" id="fileInput" name="image" class="hidden" />
                        <i class="ph ph-plus-circle text-2xl mb-2"></i>
                        <p class="text-sm">Choose File</p>
                    </label>
                    <label
                        class="flex-1 flex flex-col items-center justify-center p-4 bg-base-200 border-2 border-base-300 rounded-lg cursor-pointer hover:border-primary transition-colors"
                        id="cameraOption">
                        <input type="file" accept="image/*" capture="environment" id="cameraInput" name="image"
                            class="hidden" />
                        <i class="ph ph-camera text-2xl mb-2"></i>
                        <p class="text-sm">Take Photo</p>
                    </label>
                </div>
                <div class="text-center text-sm text-base-content/70">
                    <p class="mb-2">Supported input formats:</p>
                    <ul class="flex flex-wrap justify-center gap-2 mb-2">
                        <li>PNG</li>
                        <li>JPEG</li>
                        <li>HEIC</li>
                        <li>WebP</li>
                        <li>GIF</li>
                        <li>BMP</li>
                        <li>TIFF</li>
                        <li>ICO</li>
                    </ul>
                    <p class="text-xs italic">Images will be converted to PNG, JPEG, or WebP for optimal web delivery
                    </p>
                </div>

                <div id="previewContainer" class="hidden mt-4 text-center">
                    <div class="flex flex-col items-center gap-4">
                        <img id="previewImage" class="max-w-full max-h-[300px] rounded-lg" alt="Preview" />
                        <div class="w-full max-w-md">
                            <div id="uploadProgress" class="htmx-indicator">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-spinner text-xl animate-spin"></i>
                                    <span>Uploading...</span>
                                </div>
                                <progress class="progress progress-primary w-full mt-2"></progress>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="ph ph-upload mr-2"></i>
                                Upload
                            </button>
                            <button type="button" class="btn btn-ghost"
                                onclick="document.getElementById('previewContainer').classList.add('hidden')">
                                <i class="ph ph-x mr-2"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </section>

        <section class="bg-base-100 p-8 rounded-box shadow-sm">
            <h2 class="text-2xl font-semibold mb-6">Recent Uploads</h2>
            <div x-show="loading" class="text-center py-8 text-base-content/70">
                <i class="ph ph-spinner text-4xl animate-spin"></i>
                <p class="mt-4">Loading images...</p>
            </div>
            <div x-show="!loading && images.length === 0" class="text-center py-8 text-base-content/70">
                <i class="ph ph-image text-4xl mb-4"></i>
                <p>No images uploaded yet</p>
            </div>
            <div x-show="!loading && images.length > 0"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="card bg-base-200 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">
                            <i class="ph ph-clock"></i>
                            Recent Uploads
                        </h2>
                        <div class="overflow-x-auto">
                            <ul class="menu bg-base-100 rounded-box">
                                <template x-for="image in images" :key="image.hash">
                                    <li>
                                        <div class="flex items-center gap-4 p-2">
                                            <!-- Thumbnail -->
                                            <div class="w-16 h-16 flex-shrink-0">
                                                <img :src="'/i/' + image.hash" :alt="'Image ' + image.hash"
                                                    class="w-full h-full object-cover rounded-lg" loading="lazy" />
                                            </div>
                                            <!-- Image Info -->
                                            <div class="flex-grow min-w-0">
                                                <div class="text-sm font-mono truncate" x-text="image.hash"></div>
                                                <div class="text-xs opacity-70 truncate" x-text="'/i/' + image.hash">
                                                </div>
                                                <div class="text-xs opacity-50"
                                                    x-text="new Date(image.uploadedAt).toLocaleString()"></div>
                                            </div>
                                            <!-- Actions -->
                                            <div class="flex-shrink-0 flex gap-2">
                                                <button class="btn btn-ghost btn-sm"
                                                    @click="copyToClipboard('/i/' + image.hash)">
                                                    <i class="ph ph-copy"></i>
                                                </button>
                                                <button class="btn btn-ghost btn-sm text-error"
                                                    @click="deleteImage(image.hash)">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Delete Confirmation Modal -->
    <dialog id="deleteModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Delete Image</h3>
            <p class="py-4">Are you sure you want to delete this image? This action cannot be undone.</p>
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="document.getElementById('deleteModal').close()">Cancel</button>
                <button class="btn btn-error" id="confirmDelete">
                    <i class="ph ph-trash mr-2"></i>
                    Delete
                </button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        // Handle file input changes to show preview
        document.querySelectorAll('#fileInput, #cameraInput').forEach(input => {
            input.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (10MB limit)
                    if (file.size > 10 * 1024 * 1024) {
                        Toastify({
                            text: "File size exceeds 10MB limit",
                            duration: 3000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#ef4444",
                        }).showToast();
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const preview = document.getElementById('previewImage');
                        preview.src = e.target.result;
                        document.getElementById('previewContainer').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // Handle successful upload
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            if (evt.detail.target.id === 'previewContainer') {
                if (evt.detail.successful) {
                    console.log('Upload successful, response:', evt.detail.xhr.response);

                    // Hide preview container
                    document.getElementById('previewContainer').classList.add('hidden');

                    // Show success toast
                    Toastify({
                        text: "Image uploaded successfully!",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#22c55e",
                    }).showToast();

                    // Get the Alpine component
                    const container = document.querySelector('[x-data]');
                    const alpineData = Alpine.$data(container);

                    // Set loading state
                    alpineData.loading = true;

                    // Fetch updated list
                    fetch('/image')
                        .then(response => response.json())
                        .then(data => {
                            // Update the entire images array
                            alpineData.images = data.hashes.map(item => ({
                                hash: item.hash,
                                size: item.size,
                                uploadedAt: item.uploadedAt
                            }));
                            alpineData.loading = false;
                        })
                        .catch(error => {
                            console.error('Error refreshing images:', error);
                            alpineData.loading = false;
                            Toastify({
                                text: "Error refreshing image list",
                                duration: 3000,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "#ef4444",
                            }).showToast();
                        });
                } else {
                    console.error('Upload failed:', evt.detail.xhr.response);
                    // Show error toast
                    const errorMessage = evt.detail.xhr.responseText || 'Upload failed';
                    Toastify({
                        text: errorMessage,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#ef4444",
                    }).showToast();
                }
            }
        });

        // Handle image deletion
        document.getElementById('confirmDelete').addEventListener('click', function () {
            const modal = document.getElementById('deleteModal');
            const deleteButton = document.querySelector('[data-hash]');
            const hash = deleteButton.getAttribute('data-hash');

            // Get the Alpine component
            const container = document.querySelector('[x-data]');
            const alpineData = Alpine.$data(container);

            console.log('Deleting image:', hash);
            fetch(`/image/${hash}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete image');
                    }
                    return response.text();
                })
                .then(() => {
                    // Close the modal
                    modal.close();

                    // Show success toast
                    Toastify({
                        text: "Image deleted successfully",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#22c55e",
                    }).showToast();

                    // Set loading state
                    alpineData.loading = true;

                    // Fetch updated list
                    fetch('/image')
                        .then(response => response.json())
                        .then(data => {
                            // Update the entire images array
                            alpineData.images = data.hashes.map(item => ({
                                hash: item.hash,
                                size: item.size,
                                uploadedAt: item.uploadedAt
                            }));
                            alpineData.loading = false;
                        })
                        .catch(error => {
                            console.error('Error refreshing images:', error);
                            alpineData.loading = false;
                            Toastify({
                                text: "Error refreshing image list",
                                duration: 3000,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "#ef4444",
                            }).showToast();
                        });
                })
                .catch(error => {
                    console.error('Error deleting image:', error);
                    Toastify({
                        text: "Error deleting image",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#ef4444",
                    }).showToast();
                });
        });
    </script>
</body>

</html>